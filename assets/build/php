#!/bin/bash
#
set -e

#pecl install -f xhprof

# added xhprof extension in case anybody needs it
#cat >>/etc/php5/mods-available/xhprof.ini <<EOF
#[xhprof]
#extension=/usr/lib/php5/20100525/xhprof.so
#EOF

#php5enmod  xhprof

# localisation is UTC+1
# TODO: make it configurable
cat >>/etc/php5/mods-available/date.ini <<EOF
[Date]
date.timezone = Europe/Berlin
EOF

php5enmod date

cat >>/etc/php5/mods-available/xdebug.ini <<EOF
[debugger]
xdebug.remote_host =
xdebug.remote_enable = On
xdebug.remote_cookie_expire_time = 3600
xdebug.max_nesting_level = 400

[profiler]
xdebug.profiler_enable_trigger = On
xdebug.profiler_output_dir = /var/lib/xdebug
xdebug.profiler_output_name = cachegrind.out.%s
EOF

php5enmod xdebug

# XCACHE ###############################################################################################################
# add some memory to xcaches var cache
cat >>/etc/php5/mods-available/xcache.ini <<EOF
[xcache]
xcache.admin.enable_auth = "Off"
xcache.size = "32M"
xcache.var_size = "32M"
EOF

php5enmod xcache

cp -a /usr/share/xcache/htdocs /var/www/xcache

cat >/etc/apache2/sites-available/00-xcache <<EOF
Alias /xcache /var/www/xcache

<Directory /var/www/xcache>
    FCGIWrapper /var/www/fcgid/php-fcgi .php
    Options +ExecCGI
</Directory>
EOF

a2ensite 00-xcache
########################################################################################################################

# PHPINFO ##############################################################################################################
mkdir /var/www/phpinfo

cat >/var/www/phpinfo/index.php <<EOF
<?php
phpinfo();
?>
EOF

cat >/etc/apache2/sites-available/00-phpinfo <<EOF
Alias /phpinfo /var/www/phpinfo

<Directory /var/www/phpinfo>
    FCGIWrapper /var/www/fcgid/php-fcgi .php
    Options +ExecCGI
</Directory>
EOF

a2ensite 00-phpinfo
########################################################################################################################

sed -e "s/^\(max_execution_time\)\s*=.*\$/\1 = 240/" -i /etc/php5/cgi/php.ini
sed -e "s/^\(memory_limit\)\s*=.*\$/\1 = 512M/" -i /etc/php5/cgi/php.ini
sed -e "s/^\(display_errors\)\s*=.*\$/\1 = On/" -i /etc/php5/cgi/php.ini
sed -e "s/^\(display_startup_errors\)\s*=.*\$/\1 = On/" -i /etc/php5/cgi/php.ini
sed -e "s/^\(post_max_size\)\s*=.*\$/\1 = 2G/" -i /etc/php5/cgi/php.ini
sed -e "s/^\(upload_max_filesize\)\s*=.*\$/\1 = 2G/" -i /etc/php5/cgi/php.ini
sed -e "s/^;\?\s*\(always_populate_raw_post_data\)\s*=.*\$/\1 = -1/" -i /etc/php5/cgi/php.ini
sed -e "s/^;\?\s*\(max_input_vars\)\s*=.*\$/\1 = 1500/" -i /etc/php5/cgi/php.ini
